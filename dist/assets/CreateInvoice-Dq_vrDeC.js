import{j as e}from"./react-query-0I5YXCIV.js";import{b as X,f as Z,r}from"./react-vendor-GSsPULXx.js";import{e as P,d as M,c as ee,f as u}from"./helpers-C0Vzrg-0.js";import{c as se,a as Q,d as te,e as ae,u as ne,b as ie}from"./useData-D3VBIZIu.js";import{f as E,q as le,r as re,E as ce,c as oe,P as U,p as de}from"./ui-libs-B_77BvNz.js";import"./database-DTV7DMIG.js";import"./index-C9ltvpI4.js";import"./supabase-DfwcnzK-.js";function be(){const k=X(),{id:A}=Z(),h=!!A,{invoice:p,loading:B}=se(A),{invoices:w}=Q(),{customers:C}=te(),{products:S}=ae(),{business:c}=ne(),{settings:m}=ie(),{saveInvoice:O}=Q(),[t,d]=r.useState({id:P(),invoiceNumber:"",date:M(new Date,"input"),customerName:"",customerEmail:"",customerPhone:"",customerAddress:"",items:[{id:P(),name:"",quantity:1,price:0}],taxRate:0,discount:0,notes:"",status:"draft",user_id:""}),[Y,g]=r.useState(!1),[G,f]=r.useState(null),[N,D]=r.useState(""),[I,R]=r.useState(""),[x,L]=r.useState({}),[b,q]=r.useState(!1);r.useEffect(()=>{if(h)p&&d({...p,date:M(p.date,"input")});else if(c&&m&&w){const s=m.invoicePrefix||"INV",a=new Date().getFullYear(),n=`${s}-${a}-`,i=w.map(l=>l.invoiceNumber).filter(l=>l.startsWith(n)).map(l=>parseInt(l.split("-").pop()||"0")).filter(l=>!isNaN(l)),J=((i.length>0?Math.max(...i):0)+1).toString().padStart(4,"0"),K=`${n}${J}`;d(l=>({...l,invoiceNumber:l.invoiceNumber||K,taxRate:l.taxRate||c.taxRate||m.taxRate||0}))}},[h,p,c,m,w]);const j=r.useMemo(()=>ee(t.items,t.taxRate,t.discount),[t.items,t.taxRate,t.discount]),F=r.useMemo(()=>N?C.filter(s=>{var a;return s.name.toLowerCase().includes(N.toLowerCase())||((a=s.phone)==null?void 0:a.includes(N))}).slice(0,5):C.slice(0,5),[C,N]),z=r.useMemo(()=>I?S.filter(s=>s.name.toLowerCase().includes(I.toLowerCase())).slice(0,5):S.slice(0,5),[S,I]),o=s=>{const{name:a,value:n}=s.target;d(i=>({...i,[a]:n})),x[a]&&L(i=>({...i,[a]:null}))},v=(s,a,n)=>{d(i=>({...i,items:i.items.map(y=>y.id===s?{...y,[a]:n}:y)}))},T=()=>{d(s=>({...s,items:[...s.items,{id:P(),name:"",quantity:1,unit:"PCS",price:0}]}))},V=s=>{t.items.length>1&&d(a=>({...a,items:a.items.filter(n=>n.id!==s)}))},W=s=>{d(a=>({...a,customerName:s.name,customerEmail:s.email||"",customerPhone:s.phone||"",customerAddress:s.address||""})),g(!1),D("")},_=(s,a)=>{d(n=>({...n,items:n.items.map(i=>i.id===a?{...i,name:s.name,price:s.price,unit:s.unit||"PCS"}:i)})),f(null),R("")},H=()=>{const s={};return t.customerName.trim()||(s.customerName="Customer name is required"),t.items.some(a=>!a.name.trim())&&(s.items="All items must have a name"),t.items.some(a=>a.quantity<=0)&&(s.items="Quantity must be greater than 0"),L(s),Object.keys(s).length===0},$=async(s="draft")=>{if(H()){q(!0);try{const a={...t,status:s,date:new Date(t.date).toISOString()};await O(a),k(`/invoices/view/${t.id}`)}catch(a){console.error("Failed to save invoice:",a)}finally{q(!1)}}};return h&&B?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"w-8 h-8 text-teal-400 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-midnight-400",children:"Loading invoice..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>k(-1),className:"p-2.5 -ml-1 rounded-lg hover:bg-midnight-700 active:bg-midnight-600 transition-colors",children:e.jsx(le,{className:"w-5 h-5 text-midnight-300"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-display font-bold text-white truncate",children:h?"Edit Invoice":"Create Invoice"}),e.jsx("p",{className:"text-midnight-400 text-sm",children:t.invoiceNumber||"Generating number..."})]})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsxs("button",{onClick:()=>$("draft"),disabled:b,className:"btn-secondary flex items-center justify-center gap-2 flex-1 sm:flex-none",children:[b?e.jsx(E,{className:"w-4 h-4 animate-spin"}):e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Draft"})]}),e.jsxs("button",{onClick:()=>$("pending"),disabled:b,className:"btn-primary flex items-center justify-center gap-2 flex-1 sm:flex-none",children:[b?e.jsx(E,{className:"w-4 h-4 animate-spin"}):e.jsx(ce,{className:"w-4 h-4"}),e.jsx("span",{children:"Save & Preview"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"glass rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(oe,{className:"w-5 h-5 text-teal-400"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Customer Details"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"relative sm:col-span-2",children:[e.jsx("label",{className:"input-label",children:"Customer Name *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",name:"customerName",value:t.customerName,onChange:s=>{o(s),D(s.target.value),g(!0)},onFocus:()=>g(!0),className:`input-field ${x.customerName?"border-coral-500":""}`,placeholder:"Enter customer name"}),Y&&F.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>g(!1)}),e.jsx("div",{className:"absolute z-20 w-full mt-1 bg-midnight-800 border border-midnight-600 rounded-xl shadow-lg overflow-hidden",children:F.map(s=>e.jsxs("button",{type:"button",onClick:()=>W(s),className:"w-full px-4 py-3 text-left hover:bg-midnight-700 transition-colors",children:[e.jsx("p",{className:"text-white font-medium",children:s.name}),s.phone&&e.jsx("p",{className:"text-midnight-400 text-sm",children:s.phone})]},s.id))})]})]}),x.customerName&&e.jsx("p",{className:"text-coral-400 text-sm mt-1",children:x.customerName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Phone"}),e.jsx("input",{type:"tel",name:"customerPhone",value:t.customerPhone,onChange:o,className:"input-field",placeholder:"Phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Email"}),e.jsx("input",{type:"email",name:"customerEmail",value:t.customerEmail,onChange:o,className:"input-field",placeholder:"Email address"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"input-label",children:"Address"}),e.jsx("textarea",{name:"customerAddress",value:t.customerAddress,onChange:o,className:"input-field min-h-[60px] resize-none",placeholder:"Customer address"})]})]})]}),e.jsxs("div",{className:"glass rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Items"}),e.jsxs("button",{type:"button",onClick:T,className:"text-teal-400 hover:text-teal-300 flex items-center gap-1 text-sm",children:[e.jsx(U,{className:"w-4 h-4"}),"Add Item"]})]}),x.items&&e.jsx("p",{className:"text-coral-400 text-sm mb-4",children:x.items}),e.jsxs("div",{className:"hidden sm:grid sm:grid-cols-12 gap-2 pb-2 border-b border-midnight-600 mb-2",children:[e.jsx("div",{className:"col-span-1 text-midnight-400 text-xs font-medium",children:"#"}),e.jsx("div",{className:"col-span-4 text-midnight-400 text-xs font-medium",children:"Item Name"}),e.jsx("div",{className:"col-span-2 text-midnight-400 text-xs font-medium text-center",children:"Qty"}),e.jsx("div",{className:"col-span-1 text-midnight-400 text-xs font-medium text-center",children:"Unit"}),e.jsx("div",{className:"col-span-2 text-midnight-400 text-xs font-medium text-right",children:"Price"}),e.jsx("div",{className:"col-span-2 text-midnight-400 text-xs font-medium text-right",children:"Amount"})]}),e.jsx("div",{className:"space-y-2",children:t.items.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-2 py-2 border-b border-midnight-700/50 items-center",children:[e.jsx("div",{className:"hidden sm:flex col-span-1 text-midnight-400 text-sm items-center",children:a+1}),e.jsxs("div",{className:"sm:col-span-4 relative",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Item Name"}),e.jsx("input",{type:"text",value:s.name,onChange:n=>{v(s.id,"name",n.target.value),R(n.target.value),f(s.id)},onFocus:()=>f(s.id),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all",placeholder:"Enter item name"}),G===s.id&&z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>f(null)}),e.jsx("div",{className:"absolute z-20 w-full mt-1 bg-midnight-800 border border-midnight-600 rounded-xl shadow-lg overflow-hidden",children:z.map(n=>e.jsxs("button",{type:"button",onClick:()=>_(n,s.id),className:"w-full px-4 py-2 text-left hover:bg-midnight-700 transition-colors flex justify-between items-center",children:[e.jsx("span",{className:"text-white text-sm",children:n.name}),e.jsx("span",{className:"text-teal-400 font-mono text-sm",children:u(n.price,c.currency)})]},n.id))})]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:s.quantity,onChange:n=>v(s.id,"quantity",parseInt(n.target.value)||0),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-center focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all"})]}),e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Unit"}),e.jsx("input",{type:"text",value:s.unit||"PCS",onChange:n=>v(s.id,"unit",n.target.value),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-center focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all",placeholder:"PCS"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:s.price,onChange:n=>v(s.id,"price",parseFloat(n.target.value)||0),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-right focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all font-mono"})]}),e.jsxs("div",{className:"sm:col-span-2 flex items-center justify-between sm:justify-end gap-2",children:[e.jsx("div",{className:"sm:hidden text-midnight-400 text-xs",children:"Amount:"}),e.jsx("span",{className:"text-white font-mono text-sm font-semibold",children:u(s.quantity*s.price,c.currency)}),t.items.length>1&&e.jsx("button",{type:"button",onClick:()=>V(s.id),className:"p-1.5 text-coral-400 hover:bg-coral-500/20 rounded-lg transition-colors ml-2",children:e.jsx(de,{className:"w-4 h-4"})})]})]},s.id))}),e.jsxs("button",{type:"button",onClick:T,className:"mt-4 w-full py-2.5 border-2 border-dashed border-midnight-600 rounded-xl text-midnight-400 hover:text-teal-400 hover:border-teal-500/50 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(U,{className:"w-4 h-4"}),"Add Item"]})]}),e.jsxs("div",{className:"glass rounded-2xl p-6",children:[e.jsx("label",{className:"input-label",children:"Notes"}),e.jsx("textarea",{name:"notes",value:t.notes,onChange:o,className:"input-field min-h-[80px] resize-none",placeholder:"Add any notes..."})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"glass rounded-2xl p-6 sticky top-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"Invoice Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Invoice Number"}),e.jsx("input",{type:"text",name:"invoiceNumber",value:t.invoiceNumber,onChange:o,className:"input-field font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Invoice Date"}),e.jsx("input",{type:"date",name:"date",value:t.date,onChange:o,className:"input-field"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"input-label",children:[m.taxLabel||"Tax"," Rate (%)"]}),e.jsx("input",{type:"number",min:"0",max:"100",name:"taxRate",value:t.taxRate,onChange:o,className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Discount (%)"}),e.jsx("input",{type:"number",min:"0",max:"100",name:"discount",value:t.discount,onChange:o,className:"input-field"})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-midnight-600 space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{className:"font-mono",children:u(j.subtotal,c.currency)})]}),t.discount>0&&e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsxs("span",{children:["Discount (",t.discount,"%)"]}),e.jsxs("span",{className:"font-mono text-coral-400",children:["-",u(j.discountAmount,c.currency)]})]}),t.taxRate>0&&e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsxs("span",{children:[m.taxLabel||"Tax"," (",t.taxRate,"%)"]}),e.jsx("span",{className:"font-mono",children:u(j.taxAmount,c.currency)})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold pt-3 border-t border-midnight-600",children:[e.jsx("span",{className:"text-white",children:"Total"}),e.jsx("span",{className:"font-mono text-teal-400",children:u(j.total,c.currency)})]})]})]})})]})]})}export{be as default};
