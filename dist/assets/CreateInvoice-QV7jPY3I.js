import{j as e}from"./react-query-BSlkKaxv.js";import{b as X,e as Z,r}from"./react-vendor-DCAT8MD5.js";import{e as k,d as M,c as ee,f as u}from"./helpers-nstW7FaL.js";import{c as se,a as B,d as te,e as ae,u as ne,b as ie}from"./useData-C719uELZ.js";import{h as P,v as le,c as re,R as ce,P as Q,u as oe,w as de,E as me}from"./ui-libs-x-WnpP75.js";import"./database-BiwIQAmA.js";import"./index-B81uAijn.js";import"./supabase-DfwcnzK-.js";function je(){const D=X(),{id:E}=Z(),h=!!E,{invoice:p,loading:U}=se(E),{invoices:w}=B(),{customers:C}=te(),{products:I}=ae(),{business:c}=ne(),{settings:m}=ie(),{saveInvoice:O}=B(),[a,d]=r.useState({id:k(),invoiceNumber:"",date:M(new Date,"input"),customerName:"",customerEmail:"",customerPhone:"",customerAddress:"",items:[{id:k(),name:"",quantity:"",price:"",unit:""}],taxRate:0,discount:0,notes:"",status:"draft",user_id:""}),[Y,g]=r.useState(!1),[G,b]=r.useState(null),[f,A]=r.useState(""),[S,R]=r.useState(""),[x,L]=r.useState({}),[N,q]=r.useState(!1);r.useEffect(()=>{if(h)p&&d({...p,date:M(p.date,"input")});else if(c&&m&&w){const s=m.invoicePrefix||"INV",n=new Date().getFullYear(),t=`${s}-${n}-`,i=w.map(l=>l.invoiceNumber).filter(l=>l.startsWith(t)).map(l=>parseInt(l.split("-").pop()||"0")).filter(l=>!isNaN(l)),H=((i.length>0?Math.max(...i):0)+1).toString().padStart(4,"0"),J=`${t}${H}`;d(l=>({...l,invoiceNumber:l.invoiceNumber||J,taxRate:l.taxRate||c.taxRate||m.taxRate||0}))}},[h,p,c,m,w]);const j=r.useMemo(()=>ee(a.items,a.taxRate,a.discount),[a.items,a.taxRate,a.discount]),F=r.useMemo(()=>f?C.filter(s=>{var n;return s.name.toLowerCase().includes(f.toLowerCase())||((n=s.phone)==null?void 0:n.includes(f))}).slice(0,5):C.slice(0,5),[C,f]),z=r.useMemo(()=>S?I.filter(s=>s.name.toLowerCase().includes(S.toLowerCase())).slice(0,5):I.slice(0,5),[I,S]),o=s=>{const{name:n,value:t}=s.target;d(i=>({...i,[n]:t})),x[n]&&L(i=>({...i,[n]:null}))},v=(s,n,t)=>{d(i=>({...i,items:i.items.map(y=>y.id===s?{...y,[n]:t}:y)}))},T=()=>{d(s=>({...s,items:[...s.items,{id:k(),name:"",quantity:"",price:"",unit:""}]}))},K=s=>{a.items.length>1&&d(n=>({...n,items:n.items.filter(t=>t.id!==s)}))},V=s=>{d(n=>({...n,customerName:s.name,customerEmail:s.email||"",customerPhone:s.phone||"",customerAddress:s.address||""})),g(!1),A("")},W=(s,n)=>{d(t=>({...t,items:t.items.map(i=>i.id===n?{...i,name:s.name,price:s.price,unit:s.unit||"PCS"}:i)})),b(null),R("")},_=()=>{const s={};return a.customerName.trim()||(s.customerName="Customer name is required"),a.items.some(n=>!n.name.trim())&&(s.items="All items must have a name"),a.items.some(n=>typeof n.quantity=="string"||n.quantity<=0)&&(s.items="Quantity must be greater than 0"),L(s),Object.keys(s).length===0},$=async(s="draft")=>{if(_()){q(!0);try{const n={...a,status:s,date:new Date(a.date).toISOString(),items:a.items.map(t=>({...t,quantity:Number(t.quantity)||0,price:Number(t.price)||0}))};await O(n),D(`/invoices/view/${a.id}`)}catch(n){console.error("Failed to save invoice:",n)}finally{q(!1)}}};return h&&U?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(P,{className:"w-8 h-8 text-teal-400 animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-midnight-400",children:"Loading invoice..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>D(-1),className:"p-2.5 -ml-1 rounded-lg hover:bg-midnight-700 active:bg-midnight-600 transition-colors",children:e.jsx(le,{className:"w-5 h-5 text-midnight-300"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-display font-bold text-white truncate",children:h?"Edit Invoice":"Create Invoice"}),e.jsx("p",{className:"text-midnight-400 text-sm",children:a.invoiceNumber||"Generating number..."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"glass rounded-2xl p-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(re,{className:"w-5 h-5 text-teal-400"}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Customer Details"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"relative sm:col-span-2",children:[e.jsx("label",{className:"input-label",children:"Customer Name *"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",name:"customerName",value:a.customerName,onChange:s=>{o(s),A(s.target.value),g(!0)},onFocus:()=>g(!0),className:`input-field ${x.customerName?"border-coral-500":""}`,placeholder:"Enter customer name"}),Y&&F.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>g(!1)}),e.jsx("div",{className:"absolute z-20 w-full mt-1 bg-midnight-800 border border-midnight-600 rounded-xl shadow-lg overflow-hidden",children:F.map(s=>e.jsxs("button",{type:"button",onClick:()=>V(s),className:"w-full px-4 py-3 text-left hover:bg-midnight-700 transition-colors",children:[e.jsx("p",{className:"text-white font-medium",children:s.name}),s.phone&&e.jsx("p",{className:"text-midnight-400 text-sm",children:s.phone})]},s.id))})]})]}),x.customerName&&e.jsx("p",{className:"text-coral-400 text-sm mt-1",children:x.customerName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Phone"}),e.jsx("input",{type:"tel",name:"customerPhone",value:a.customerPhone,onChange:o,className:"input-field",placeholder:"Phone number"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Email"}),e.jsx("input",{type:"email",name:"customerEmail",value:a.customerEmail,onChange:o,className:"input-field",placeholder:"Email address"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"input-label",children:"Address"}),e.jsx("textarea",{name:"customerAddress",value:a.customerAddress,onChange:o,className:"input-field min-h-[60px] resize-none",placeholder:"Customer address"})]})]})]}),e.jsxs("div",{className:"glass rounded-2xl p-6 ring-2 ring-teal-500/20",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-teal-500/20 flex items-center justify-center",children:e.jsx(ce,{className:"w-4 h-4 text-teal-400"})}),e.jsx("h2",{className:"text-lg font-semibold text-white",children:"Items"})]}),e.jsxs("button",{type:"button",onClick:T,className:"btn-secondary flex items-center gap-2 text-sm",children:[e.jsx(Q,{className:"w-4 h-4"}),"Add Item"]})]}),x.items&&e.jsx("p",{className:"text-coral-400 text-sm mb-4",children:x.items}),e.jsxs("div",{className:"hidden sm:grid sm:grid-cols-12 gap-2 pb-2 border-b border-midnight-600 mb-2",children:[e.jsx("div",{className:"col-span-1 text-midnight-400 text-xs font-medium",children:"#"}),e.jsx("div",{className:"col-span-3 text-midnight-400 text-xs font-medium",children:"Item Name"}),e.jsx("div",{className:"col-span-2 text-midnight-400 text-xs font-medium text-center",children:"Qty"}),e.jsx("div",{className:"col-span-1 text-midnight-400 text-xs font-medium text-center",children:"Unit"}),e.jsx("div",{className:"col-span-2 text-midnight-400 text-xs font-medium text-right",children:"Price"}),e.jsx("div",{className:"col-span-3 text-midnight-400 text-xs font-medium text-right",children:"Amount"})]}),e.jsx("div",{className:"space-y-2",children:a.items.map((s,n)=>e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-12 gap-2 py-2 border-b border-midnight-700/50 items-center",children:[e.jsx("div",{className:"hidden sm:flex col-span-1 text-midnight-400 text-sm items-center",children:n+1}),e.jsxs("div",{className:"sm:col-span-3 relative",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Item Name"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>{v(s.id,"name",t.target.value),R(t.target.value),b(s.id)},onFocus:()=>b(s.id),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all",placeholder:"Enter item name"}),G===s.id&&z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>b(null)}),e.jsx("div",{className:"absolute z-20 w-full mt-1 bg-midnight-800 border border-midnight-600 rounded-xl shadow-lg overflow-hidden",children:z.map(t=>e.jsxs("button",{type:"button",onClick:()=>W(t,s.id),className:"w-full px-4 py-2 text-left hover:bg-midnight-700 transition-colors flex justify-between items-center",children:[e.jsx("span",{className:"text-white text-sm",children:t.name}),e.jsx("span",{className:"text-teal-400 font-mono text-sm",children:u(t.price,c.currency)})]},t.id))})]})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:s.quantity,onChange:t=>v(s.id,"quantity",parseInt(t.target.value)||""),onKeyDown:t=>{!/[0-9]/.test(t.key)&&!["Backspace","Delete","ArrowLeft","ArrowRight","Tab"].includes(t.key)&&t.preventDefault()},className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-center focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]}),e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Unit"}),e.jsx("input",{type:"text",value:s.unit||"",onChange:t=>v(s.id,"unit",t.target.value),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-center focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all",placeholder:""})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"sm:hidden text-midnight-400 text-xs mb-1 block",children:"Price"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:s.price,onChange:t=>v(s.id,"price",parseFloat(t.target.value)||""),className:"w-full bg-midnight-800/50 border border-midnight-600 rounded-lg px-3 py-2 text-white text-sm text-right focus:border-teal-500 focus:ring-1 focus:ring-teal-500/20 transition-all font-mono [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"})]}),e.jsxs("div",{className:"sm:col-span-3 flex items-center justify-between sm:justify-end gap-2",children:[e.jsx("div",{className:"sm:hidden text-midnight-400 text-xs",children:"Amount:"}),e.jsx("span",{className:"text-white font-mono text-sm font-semibold truncate",children:u((Number(s.quantity)||0)*(Number(s.price)||0),c.currency)}),a.items.length>1&&e.jsx("button",{type:"button",onClick:()=>K(s.id),className:"p-1.5 text-coral-400 hover:bg-coral-500/20 rounded-lg transition-colors ml-2",children:e.jsx(oe,{className:"w-4 h-4"})})]})]},s.id))}),e.jsxs("button",{type:"button",onClick:T,className:"mt-4 w-full py-2.5 border-2 border-dashed border-midnight-600 rounded-xl text-midnight-400 hover:text-teal-400 hover:border-teal-500/50 transition-colors flex items-center justify-center gap-2 text-sm",children:[e.jsx(Q,{className:"w-4 h-4"}),"Add Item"]})]}),e.jsxs("div",{className:"glass rounded-2xl p-6",children:[e.jsx("label",{className:"input-label",children:"Notes"}),e.jsx("textarea",{name:"notes",value:a.notes,onChange:o,className:"input-field min-h-[80px] resize-none",placeholder:"Add any notes..."})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"glass rounded-2xl p-6 sticky top-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-white mb-4",children:"Invoice Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Invoice Number"}),e.jsx("input",{type:"text",name:"invoiceNumber",value:a.invoiceNumber,onChange:o,className:"input-field font-mono"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Invoice Date"}),e.jsx("input",{type:"date",name:"date",value:a.date,onChange:o,className:"input-field"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"input-label",children:[m.taxLabel||"Tax"," Rate (%)"]}),e.jsx("input",{type:"number",min:"0",max:"100",name:"taxRate",value:a.taxRate,onChange:o,className:"input-field"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"input-label",children:"Discount (%)"}),e.jsx("input",{type:"number",min:"0",max:"100",name:"discount",value:a.discount,onChange:o,className:"input-field"})]})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t border-midnight-600 space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{className:"font-mono",children:u(j.subtotal,c.currency)})]}),a.discount>0&&e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsxs("span",{children:["Discount (",a.discount,"%)"]}),e.jsxs("span",{className:"font-mono text-coral-400",children:["-",u(j.discountAmount,c.currency)]})]}),a.taxRate>0&&e.jsxs("div",{className:"flex justify-between text-midnight-300",children:[e.jsxs("span",{children:[m.taxLabel||"Tax"," (",a.taxRate,"%)"]}),e.jsx("span",{className:"font-mono",children:u(j.taxAmount,c.currency)})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold pt-3 border-t border-midnight-600",children:[e.jsx("span",{className:"text-white",children:"Total"}),e.jsx("span",{className:"font-mono text-teal-400",children:u(j.total,c.currency)})]})]})]})})]}),e.jsx("div",{className:"sticky bottom-0 z-10 mt-6 -mx-6 px-6 py-4 bg-midnight-900/95 backdrop-blur-lg border-t border-midnight-700",children:e.jsxs("div",{className:"flex items-center gap-3 max-w-7xl mx-auto",children:[e.jsxs("button",{onClick:()=>$("draft"),disabled:N,className:"btn-secondary flex items-center justify-center gap-2 flex-1 sm:flex-none sm:min-w-[140px]",children:[N?e.jsx(P,{className:"w-4 h-4 animate-spin"}):e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{children:"Save Draft"})]}),e.jsxs("button",{onClick:()=>$("pending"),disabled:N,className:"btn-primary flex items-center justify-center gap-2 flex-1 sm:flex-none sm:min-w-[160px]",children:[N?e.jsx(P,{className:"w-4 h-4 animate-spin"}):e.jsx(me,{className:"w-4 h-4"}),e.jsx("span",{children:"Save & Preview"})]})]})})]})}export{je as default};
